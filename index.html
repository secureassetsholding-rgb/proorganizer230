<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dashboard - OrganizerPro</title>

  <!-- 1) SDKs de Firebase (modo compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- 2) Tu configuración Firebase (ahora llamado firebase.js) -->
  <script src="/Proorganicer230/firebase.js"></script>

  <!-- 3) Estilos y Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  
  <!-- 4) Manifest y PWA -->
  <link rel="manifest" href="/Proorganicer230/manifest.json">
  <link rel="icon" href="/Proorganicer230/icon-192x192.png">

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      color: #333;
    }

    .sidebar {
      width: 250px;
      height: 100vh;
      background-color: #2c3e50;
      color: #ecf0f1;
      position: fixed;
      left: 0;
      top: 0;
      padding-top: 20px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.1);
    }

    .sidebar .menu-item {
      display: block;
      padding: 15px 20px;
      color: #ecf0f1;
      text-decoration: none;
      border-bottom: 1px solid #34495e;
      transition: background 0.3s;
    }

    .sidebar .menu-item:hover {
      background-color: #34495e;
    }

    .main-content {
      margin-left: 250px;
      padding: 20px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background-color: #fff;
      padding: 15px 20px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .topbar h1 {
      margin: 0;
      font-size: 1.5em;
      color: #2c3e50;
    }

    .user-info {
      text-align: right;
    }

    .user-info strong {
      font-size: 1.1em;
    }

    .widgets-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .widget {
      background-color: #fff;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      text-align: center;
    }

    .widget h3 {
      margin: 0 0 10px 0;
      color: #2c3e50;
      font-size: 1.1em;
    }

    .widget p {
      margin: 0;
      font-size: 1.5em;
      font-weight: bold;
      color: #3498db;
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <a href="dashboard.html" class="menu-item">
      <i class="fas fa-chart-line"></i> Dashboard
    </a>
    <a href="events.html" class="menu-item">
      <i class="fas fa-calendar-alt"></i> Eventos
    </a>
    <a href="contacts.html" class="menu-item">
      <i class="fas fa-address-book"></i> Contactos
    </a>
    <a href="notes.html" class="menu-item">
      <i class="fas fa-sticky-note"></i> Notas
    </a>
    <a href="tasks.html" class="menu-item">
      <i class="fas fa-tasks"></i> Tareas
    </a>
    <a href="#" class="menu-item" onclick="cerrarSesion()">
      <i class="fas fa-sign-out-alt"></i> Cerrar Sesión
    </a>
  </div>

  <!-- Main content -->
  <div class="main-content">
    <div class="topbar">
      <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
      <div class="user-info">
        <strong id="userName">Usuario</strong>
        <div id="currentDate"></div>
      </div>
    </div>

    <!-- Widgets -->
    <div class="widgets-grid">
      <div class="widget">
        <h3>Eventos Hoy</h3>
        <p id="eventosHoy">0</p>
      </div>
      <div class="widget">
        <h3>Contactos</h3>
        <p id="totalContactos">0</p>
      </div>
      <div class="widget">
        <h3>Notas</h3>
        <p id="totalNotas">0</p>
      </div>
      <div class="widget">
        <h3>Tareas Pendientes</h3>
        <p id="tareasPendientes">0</p>
      </div>
      <div class="widget">
        <h3>Recordatorios Activos</h3>
        <p id="recordatoriosActivos">0</p>
      </div>
      <div class="widget">
        <h3>Nuevo Recordatorio en</h3>
        <p id="proximoRecordatorio">--</p>
      </div>
      <div class="widget">
        <h3>Balance del Mes</h3>
        <p id="balanceMes">$0.00</p>
      </div>
    </div>
  </div>

  <!-- Script principal -->
  <script>
    // ✅ Inicializar Firebase (ya está en firebase.js)
    // No necesitas re-inicializar

    // ✅ Proteger página y cargar estadísticas
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        console.log('❌ No autenticado, redirigiendo a login...');
        window.location.href = '/Proorganicer230/login.html';
        return;
      }

      try {
        // Mostrar nombre y fecha
        const userDoc = await db.collection('users').doc(user.uid).get();
        if (userDoc.exists) {
          document.getElementById('userName').textContent = userDoc.data().name || 'Usuario';
        } else {
          document.getElementById('userName').textContent = 'Usuario';
        }

        const hoy = new Date().toLocaleDateString('es-ES', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
        document.getElementById('currentDate').textContent = hoy;

        // Cargar estadísticas
        await cargarEstadisticas();
        setInterval(cargarEstadisticas, 30000);

      } catch (error) {
        console.error('Error al cargar datos del dashboard:', error);
        mostrarNotificacion('Error al cargar datos. Intenta nuevamente.', 'error');
      }
    });

    // ✅ Función para cargar estadísticas desde Firestore
    async function cargarEstadisticas() {
      const user = auth.currentUser;
      if (!user) return;

      const hoy = new Date().toISOString().split('T')[0];
      const ahora = new Date();

      // Eventos de hoy
      try {
        const eSnap = await db.collection('events')
          .where('userId', '==', user.uid)
          .where('date', '==', hoy)
          .get();
        document.getElementById('eventosHoy').textContent = eSnap.size;
      } catch (error) {
        console.error('Error en eventos hoy:', error);
      }

      // Contactos totales
      try {
        const cSnap = await db.collection('contacts')
          .where('userId', '==', user.uid)
          .get();
        document.getElementById('totalContactos').textContent = cSnap.size;
      } catch (error) {
        console.error('Error en contactos:', error);
      }

      // Notas
      try {
        const nSnap = await db.collection('notes')
          .where('userId', '==', user.uid)
          .get();
        document.getElementById('totalNotas').textContent = nSnap.size;
      } catch (error) {
        console.error('Error en notas:', error);
      }

      // Tareas pendientes
      try {
        const tSnap = await db.collection('tasks')
          .where('userId', '==', user.uid)
          .where('completada', '==', false)
          .get();
        document.getElementById('tareasPendientes').textContent = tSnap.size;
      } catch (error) {
        console.error('Error en tareas:', error);
      }

      // Recordatorios activos
      try {
        const rSnap = await db.collection('reminders')
          .where('userId', '==', user.uid)
          .where('fecha', '>=', ahora.toISOString())
          .get();
        document.getElementById('recordatoriosActivos').textContent = rSnap.size;
      } catch (error) {
        console.error('Error en recordatorios:', error);
      }

      // Próximo recordatorio
      try {
        if (rSnap.size > 0) {
          const arr = [];
          rSnap.forEach(doc => arr.push(doc.data()));
          arr.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
          const diff = Math.floor((new Date(arr[0].fecha) - ahora) / 60000);
          document.getElementById('proximoRecordatorio').textContent =
            diff > 60 ? `${Math.floor(diff / 60)}h` : `${diff}min`;
        } else {
          document.getElementById('proximoRecordatorio').textContent = '--';
        }
      } catch (error) {
        console.error('Error en próximo recordatorio:', error);
      }

      // Balance del mes
      try {
        const mes = ahora.getMonth();
        const año = ahora.getFullYear();
        let balance = 0;

        const expSnap = await db.collection('expenses')
          .where('userId', '==', user.uid)
          .get();

        expSnap.forEach(doc => {
          const data = doc.data();
          const fecha = new Date(data.fecha);
          if (fecha.getMonth() === mes && fecha.getFullYear() === año) {
            balance += data.tipo === 'ingreso' ? data.monto : -data.monto;
          }
        });

        document.getElementById('balanceMes').textContent = `$${balance.toFixed(2)}`;
      } catch (error) {
        console.error('Error en balance del mes:', error);
        document.getElementById('balanceMes').textContent = '$0.00';
      }
    }
  </script>

  <!-- ✅ Servicio Worker (PWA) -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/Proorganicer230/service-worker.js')
          .then(reg => console.log('Service Worker registrado:', reg))
          .catch(err => console.error('Error al registrar Service Worker:', err));
      });
    }
  </script>
</body>
</html>